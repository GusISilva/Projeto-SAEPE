{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/visitas.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="visitas-container my-5">

    <div class="header-section d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title">Gestão de Visitas Técnicas</h1>
            <p class="page-subtitle">Acompanhe a última visita registrada e adicione novas.</p> </div>
        <button type="button" class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#visitModal">
            <i class="fas fa-plus-circle"></i> Adicionar Nova Visita
        </button>
    </div>

    <div class="visits-card card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">Resumo da Última Visita por Escola</h3>
            <input type="text" id="filterInput" class="form-control w-auto search-bar" placeholder="Buscar por escola..." onkeyup="filterTable()">
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table class="visits-table table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Escola</th>
                            <th>Data da Última Visita</th>
                            <th>Técnico (Última Visita)</th>
                            </tr>
                    </thead>
                    <tbody id="visitsTableBody">
                        {% for ultima_visita in resumo_visitas %}
                        <tr>
                            <td>
                                <a href="{% url 'perfil_escola' escola_nome=ultima_visita.escola %}">
                                    {{ ultima_visita.escola }}
                                </a>
                            </td>
                            <td>{{ ultima_visita.data_visita|date:"d/m/Y" }}</td>
                            <td>{{ ultima_visita.tecnico_gre|default:"" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted">Nenhuma visita registada ainda.</td>
                        </tr>
                        {% endfor %} </tbody>
                </table>
            </div>
        </div>
    </div> </div> <div class="modal fade" id="visitModal" tabindex="-1" aria-labelledby="visitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <form action="{% url 'visitas' %}" method="POST">
                {% csrf_token %}

                <div class="modal-header">
                    <h5 class="modal-title" id="visitModalLabel">Registar Nova Visita Técnica</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    {% if messages %}
                        {% for message in messages %}
                            {% if "error" in message.tags %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form_modal.escola.id_for_label }}">{{ form_modal.escola.label }}*</label>
                            {{ form_modal.escola }}
                        </div>
                         <div class="col-md-6">
                            <label class="form-label" for="{{ form_modal.data_visita.id_for_label }}">{{ form_modal.data_visita.label }}*</label>
                            {{ form_modal.data_visita }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form_modal.tecnico_gre.id_for_label }}">{{ form_modal.tecnico_gre.label }}*</label>
                            {{ form_modal.tecnico_gre }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form_modal.servidor_escola.id_for_label }}">{{ form_modal.servidor_escola.label }}*</label>
                            {{ form_modal.servidor_escola }}
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="{{ form_modal.demanda.id_for_label }}">{{ form_modal.demanda.label }}*</label>
                            {{ form_modal.demanda }}
                        </div>
                         <div class="col-md-6">
                            <label class="form-label" for="{{ form_modal.encaminhamento.id_for_label }}">{{ form_modal.encaminhamento.label }}</label>
                            {{ form_modal.encaminhamento }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form_modal.observacao.id_for_label }}">{{ form_modal.observacao.label }}</label>
                            {{ form_modal.observacao }}
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Visita</button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    function filterTable() {
        const input = document.getElementById('filterInput');
        const filter = input ? input.value.toLowerCase() : '';
        const table = document.getElementById('visitsTableBody');
        if (!table) return;
        const rows = table.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            // Verifica se a linha tem células 'td' antes de tentar aceder
            if (rows[i].getElementsByTagName('td').length > 0) { 
                // O nome da escola está na primeira célula (índice 0)
                const schoolNameCell = rows[i].getElementsByTagName('td')[0]; 
                if (schoolNameCell) {
                    // Tenta encontrar o link <a> dentro da célula
                    const schoolLink = schoolNameCell.getElementsByTagName('a')[0];
                    // Pega o texto do link, ou da célula se não houver link
                    const textValue = schoolLink ? (schoolLink.textContent || schoolLink.innerText) : (schoolNameCell.textContent || schoolNameCell.innerText);
                    
                    if (textValue.toLowerCase().indexOf(filter) > -1) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const errorAlert = document.querySelector('#visitModal .modal-body .alert-danger'); 
        const visitModalElement = document.getElementById('visitModal');
        
        if (errorAlert && visitModalElement && typeof bootstrap !== 'undefined') { 
            const isModalHidden = !visitModalElement.classList.contains('show');
            if (isModalHidden) {
                try {
                    const visitModal = bootstrap.Modal.getOrCreateInstance(visitModalElement);
                    visitModal.show();
                } catch (e) {
                    console.error("Erro ao tentar reabrir o modal Bootstrap:", e);
                }
            }
        }
    });
</script>

{% endblock content %}